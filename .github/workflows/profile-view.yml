name: GitHub Profile Views Counter CI

on:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours
  workflow_dispatch:

permissions:
  contents: write   # allow GITHUB_TOKEN to push commits

jobs:
  release:
    name: GitHub Profile Views Counter Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          token: ${{ github.token }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run profile views counter
        uses: gayanvoice/github-profile-views-counter-action@3.0.0
        env:
          INSIGHTS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit visitor count
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Ensure remote uses authenticated token
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          # Stage and commit count.svg if changed
          git add count.svg || true
          git diff --cached --quiet || git commit -m "Update visitor count"
          git push origin HEAD:${{ github.ref }}
